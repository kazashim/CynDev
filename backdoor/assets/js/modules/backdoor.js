/*
@category		PHP CMS
@package		Backdoor - Your Online Companion Editor
@author			Shannon Reca <iam@shannonreca.com>
@copyright	2015 Shannon Reca
@usage			For more specific usage see the documentation at http://backdoor.shannonreca.com
@license		http://codecanyon.net/licenses/standard
@version		build-020216 v1.3
@since			02/02/16
@feedback		Email: feedback@shannonreca.com
*/
define(["jquery","codemirror","scrollbar","cmAddonScroll","cmModeHtml","cmModeJs","cmModeCss","cmModeXml","cmModeScheme","cmModeCoffee","cmModeJade","cmModeMarkdown","cmModePerl","cmModePhp","cmModePython","cmModeRuby","cmModeSass","cmModeShell","cmModeSql","cmModeVb","cmModeVbscript","cmModeXml","cmModeYaml","iframeTrans","knob","jquery.ui.widget","jquery.ui","fileUpload","sweetalert"],function($,CodeMirror,perfectScrollbar){var Backdoor;return Backdoor=function(){function Backdoor(e){this.options=e,this.options=$.extend({},this.defaults(),this.options),this.global=this.initGlobals(),this.additionalSelectors(),this.delegateEvents(),this.initContextCalls()}return Backdoor.prototype.defaults=function(){return{browserId:"#fileBrowser",breadcrumbId:"#fileBreadcrumbs",tools:"#toolNav",webDevDir:"http://localhost/fedcms",fileMenu:"#headerMenu",rightClickMenu:"#contextMenu",dialogBoxes:"#dialogBoxes",disable:"#contextDisable",tabViews:"#tabViews",views:"#views",fileUploader:"#fileUpload",dropZone:"#drop",feedback:"#feedback",chat:"#chatBox",chatRefresh:4e3,chatLogRefresh:4e3,chatOnlineRefresh:4e3,token:"no-token",saveAlerts:!0}},Backdoor.prototype.initGlobals=function(){var e;return e={"switch":{scrollBuilt:!1},timers:{},file:{name:null,format:null,content:null,location:null},chat:{logViewUID:null,file:null,members:null},apiUrls:{chat:{online:this.options.webDevDir+"/backdoor/core-modules/user-manager/chat-manager/online.json",log:this.options.webDevDir+"/backdoor/core-modules/user-manager/chat-manager/log.json",data:this.options.webDevDir+"/backdoor/core-modules/user-manager/chat-manager/getUserData.php",create:this.options.webDevDir+"/backdoor/core-modules/user-manager/chat-manager/createConversation.php",open:this.options.webDevDir+"/backdoor/core-modules/user-manager/chat-manager/openConversation.php",update:this.options.webDevDir+"/backdoor/core-modules/user-manager/chat-manager/updateConversation.php"},file:{loader:this.options.webDevDir+"/backdoor/core-modules/file-processor/loader.php",handler:this.options.webDevDir+"/backdoor/core-modules/file-processor/handler.php"},user:{add:this.options.webDevDir+"/backdoor/core-modules/user-manager/addUser.php",list:this.options.webDevDir+"/backdoor/core-modules/user-manager/getUsersList.php",update:this.options.webDevDir+"/backdoor/core-modules/user-manager/update.php","delete":this.options.webDevDir+"/backdoor/core-modules/user-manager/deleteUser.php"},mailer:this.options.webDevDir+"/backdoor/core-modules/user-manager/mailer.php",config:this.options.webDevDir+"/backdoor/core-modules/config.php"}}},Backdoor.prototype.format=null,Backdoor.prototype.contentHolder=null,Backdoor.prototype.scrollBuilt=!1,Backdoor.prototype.currentDirUrl=null,Backdoor.prototype.mX=0,Backdoor.prototype.mY=0,Backdoor.prototype.contextCall=null,Backdoor.prototype.contextFile=null,Backdoor.prototype.contextData=null,Backdoor.prototype.additionalSelectors=function(){return this.options.$browserId=$(this.options.browserId),this.options.$breadcrumbId=$(this.options.breadcrumbId),this.options.$tools=$(this.options.tools),this.options.$fileMenu=$(this.options.fileMenu),this.options.$rightClickMenu=$(this.options.rightClickMenu),this.options.$dialogBoxes=$(this.options.dialogBoxes),this.options.$disable=$(this.options.disable),this.options.$tabViews=$(this.options.tabViews),this.options.$views=$(this.options.views),this.options.$fileUploader=$(this.options.fileUploader),this.options.$dropZone=$(this.options.dropZone),this.options.$feedback=$(this.options.feedback),this.options.$chat=$(this.options.chat)},Backdoor.prototype.serviceCall=function(url,data,callBack){var _self;return _self=this,$.ajax({headers:{"Bd-Api-Session":_self.options.token},url:url,async:!1,method:"POST",dataType:"json",data:data,error:function(xhr,status,error){var err;return err=eval("("+xhr.statusText+")"),swal({title:"Error!",text:err,confirmButtonColor:"#ff004a",type:"error"})},success:function(e,t,o){return null!==url.match(/loader.php/gi)||null!==url.match(/getUsersList.php/gi)||null!==url.match(/config.php/gi)||null!==url.match(/chat-manager/gi)||null!==url.match(/getUserData.php/gi)?callBack(e):"true"===e.success?_self.options.saveAlerts?swal({title:"Success!",text:e.msg,confirmButtonColor:"#ff004a",type:"success"},function(){return callBack(e)}):callBack(e):swal({title:"Error!",text:e.msg,confirmButtonColor:"#ff004a",type:"error"})}})},Backdoor.prototype.checkBackInLoop=function(e,t,o){var i,n;return null==o&&(o=!1),n=this,i=Number(t),this.global.timers[e]=setTimeout(function(){return o&&"getChatLog"!==e?n[e](o):o&&"getChatLog"===e?n[e](o,!0):n[e]()},i)},Backdoor.prototype.resizeEvents=function(){var e,t;return t=this,e=null,$(window).resize(function(){return clearTimeout(e),e=setTimeout(function(){return t.adjustChatViewHeight()},500)})},Backdoor.prototype.delegateEvents=function(){var e,t;return t=this,this.options.$body=$("body"),this.currentDirUrl=this.options.webDevDir+"/backdoor_browser.php",this.getDirectory(this.options.$browserId,this.currentDirUrl),this.options.$tabViews.sortable(),this.resizeEvents(),document.addEventListener("keydown",function(e){83===e.keyCode&&(navigator.platform.match("Mac")?e.metaKey:e.ctrlKey)&&(e.preventDefault(),t.contextCall="saveFile",t.contextFile=t.options.$views.find(".view.active").find('input[name="fileLoc"]').val(),t.saveDoc())},!1),this.options.$chat.find(".chat-users").resizable({minHeight:44,stop:function(e,o){return t.adjustChatViewHeight(),t.scrollChatView()}}),$(""+this.options.chat+" textarea").keydown(function(e){return 13!==e.keyCode||e.shiftKey?void 0:(e.preventDefault(),t.updateConversation())}),$(document).on("click",""+this.options.chat+" .chat-text button",function(){return t.getChatLog($(this).data("id")),void 0!==this.global.timers.openConversation?clearTimeout(t.global.timers.openConversation):void 0}),$(document).on("click",""+this.options.chat+" .chat-user",function(){return t.getChatLog($(this).data("id"))}),$(document).on("click",""+this.options.chat+" .chat-list",function(){var e;return e=$(this).data("user-ids").split(","),t.global.chat.members=e,t.openConversation($(this).data("chat-file"))}),$(document).on("click",""+this.options.chat+" .chat-convo .chat-header button",function(){return t.getChatLog(t.global.chat.logViewUID,!0)}),$(document).on("click",""+this.options.breadcrumbId+" button",function(){return t.currentDirUrl=$(this).data("url"),t.getDirectory(t.options.$browserId,t.currentDirUrl),t.options.$body.hasClass("open-tools")?t.options.$body.hasClass("open-upload")?(t.options.$body.removeClass("open-upload"),t.options.$body.addClass("open-browser")):void 0:t.options.$body.addClass("open-tools open-browser")}),$(document).on("click",""+this.options.browserId+" button",function(){var e,o,i,n,a;return i=$(this).parent(),n=$(this).data("url"),a=$(this).data("open"),e=$(this).clone(),e.find("span").remove(),o=e.text(),i.hasClass("folder")?i.hasClass("open-folder")?(i.find("ul").remove(),i.removeClass("open-folder"),$(this).siblings("i").removeClass("fa-folder-open").addClass("fa-folder")):(t.currentDirUrl=n,t.getDirectory(i,t.currentDirUrl),i.addClass("open-folder"),$(this).siblings("i").removeClass("fa-folder").addClass("fa-folder-open")):t.isOpened(n)?void 0:t.createView(a,n,o)}),$(document).on("click",""+this.options.tools+" button",function(e){var o,i,n,a,s;if(e.preventDefault(),a=$(this).data("menu-id"),"chat"===a){if(t.options.$body.hasClass("open-chat")){s=t.global.timers;for(o in s)i=s[o],clearTimeout(t.global.timers[o]);t.options.$body.removeClass("open-chat")}else t.adjustChatViewHeight(),t.checkWhosOnline(),t.getChatLog("all"),t.options.$body.addClass("open-chat");return $(this).parent().toggleClass("active")}return"new-file"===a?t.createView("editor","new","untitled"):($(this).parent().siblings(":not(:last-child)").removeClass("active"),$(this).parent().addClass("active"),n="open-"+a,t.options.$body.hasClass("open-tools")?t.options.$body.hasClass(n)?t.options.$body.removeClass("open-tools open-browser open-upload"):(t.options.$body.removeClass("open-browser open-upload"),t.options.$body.addClass(n),"browser"===a?t.getDirectory(t.options.$browserId,t.currentDirUrl):void 0):(t.options.$body.addClass("open-tools"),t.options.$body.addClass(n)))}),this.listener(),this.tracker(),this.resetContext(),this.options.$disable.click(function(){return t.options.$body.removeClass("open-context open-dialog provide-disable-layer"),t.options.$fileMenu.find(".open-file-menu").removeClass("open-file-menu"),t.resetContext()}),this.options.$fileMenu.find("li > button").on("click",function(){return t.options.$body.addClass("provide-disable-layer"),$(this).parent().toggleClass("open-file-menu"),$(this).parent().siblings("li").removeClass("open-file-menu")}),this.options.$fileMenu.find("li > ul > li > button").on("click",function(){var e;return t.options.$body.removeClass("provide-disable-layer"),e=$(this).data("menu-id"),t.options.$fileMenu.find(".open-file-menu").removeClass("open-file-menu"),"newFile"===e?t.createView("editor","new","untitled"):"editConfig"===e?t.createView("editor",t.global.apiUrls.config):"updatePass"===e?(t.options.$dialogBoxes.find(".active").removeClass("active"),t.options.$dialogBoxes.find("#userLogin").addClass("active"),t.options.$body.addClass("open-dialog provide-disable-layer")):"addUser"===e?(t.options.$dialogBoxes.find(".active").removeClass("active"),t.options.$dialogBoxes.find("#addUser").addClass("active"),t.options.$body.addClass("open-dialog provide-disable-layer")):"deleteUser"===e?t.serviceCall(t.global.apiUrls.user.list,{},function(e){var o,i,n,a,s;for(a="",s=e.list,i=0,n=s.length;n>i;i++)o=s[i],a+="<li>\n  "+o.email+'\n  <button data-uid="'+o.uid+'">Delete</button>\n</li>';return t.options.$dialogBoxes.find("#deleteUser").find(".dialog-box-list").html(a),t.options.$dialogBoxes.find(".active").removeClass("active"),t.options.$dialogBoxes.find("#deleteUser").addClass("active"),t.options.$body.addClass("open-dialog provide-disable-layer")}):void 0}),$(document).on("click",""+this.options.dialogBoxes+" button[data-uid]",function(e){var o;return o=$(this).attr("data-uid"),t.serviceCall(t.global.apiUrls.user["delete"],{uid:o},function(e){return t.options.$body.removeClass("open-dialog provide-disable-layer")})}),this.options.$dialogBoxes.find(".dialog-box-cancel").on("click",function(){return t.options.$body.removeClass("open-dialog provide-disable-layer")}),this.options.$dialogBoxes.find("#ULupdate").on("click",function(){return""===$("#ULemail").val()||""===$("#ULpass").val()?swal({title:"Error!",text:"Your current email and password is needed.",confirmButtonColor:"#ff004a",type:"error"}):t.serviceCall(t.global.apiUrls.user.update,{user:$("#ULemail").val(),pass:$("#ULpass").val(),newUser:$("#ULnewEmail").val(),newPass:$("#ULnewPass").val()},function(e){return t.options.$body.removeClass("open-dialog provide-disable-layer"),$("#ULpass, #ULnewEmail, #ULnewPass").val("")})}),this.options.$dialogBoxes.find("#AUadd").on("click",function(){return""===$("#AUemail").val()||""===$("#AUpass").val()?swal({title:"Error!",text:"An email and password is needed.",confirmButtonColor:"#ff004a",type:"error"}):t.serviceCall(t.global.apiUrls.user.add,{user:$("#AUemail").val(),pass:$("#AUpass").val()},function(e){return t.options.$body.removeClass("open-dialog provide-disable-layer"),$("#AUemail, #AUpass").val("")})}),$(document).bind("DOMNodeInserted",function(e){var o,i,n,a,s,r,l,c,d,p;return i=$(e.target),l=i.data("editor-mode"),i.hasClass("view")&&void 0!==l?(c=i.data("view-id"),d=i.data("editor-mode"),p=i.find(".view-textarea")[0],o=i.find(".view-character-count"),n=i.find(".view-mode"),a=$("#tabViews li[data-id='"+c+"']"),r=CodeMirror.fromTextArea(p,{lineNumbers:!0,lineWrapping:!0,tabSize:2,matchBrackets:!0,tabMode:"indent",indentWithTabs:!0,scrollbarStyle:"simple",cursorHeight:.65,keymap:"sublime",mode:d,theme:"monokai"}),s=r.getValue(),o.html(s.length),r.on("change",function(){return s=r.getValue(),o.html(s.length),a.find("span").length?void 0:a.wrapInner("<span></span>")}),document[c]=r,n.val(d),n.on("change",function(){return i.attr("data-editor-mode",$(this).val()),t.updateMode(r,$(this).val())})):void 0}),$(document).on("click",""+this.options.tabViews+" li",function(){var e;return e=$(this).data("id"),$(this).addClass("active").siblings("li").removeClass("active"),t.options.$views.find(".view[data-view-id='"+e+"']").addClass("active").siblings(".view").removeClass("active")}),$(document).on("click",""+this.options.tabViews+" li .close",function(){var e;return e=$(this).closest("li").data("id"),delete document[e],$(this).closest("li").remove(),t.options.$views.find(".view[data-view-id='"+e+"']").remove()}),$(document).on("click",""+this.options.views+" .view .CodeMirror",function(){var e;return e=$(this).parent().data("view-id"),$(this).parent().addClass("active").siblings(".view").removeClass("active"),t.options.$tabViews.find("li[data-id='"+e+"']").addClass("active").siblings(".view").removeClass("active")}),this.options.$feedback.find(".feedback-tab").click(function(){return t.options.$body.toggleClass("open-feedback")}),this.options.$feedback.find("button.feedback-send-button").click(function(){return t.serviceCall(t.global.apiUrls.mailer,{fromEmail:t.options.$feedback.find('input[name="fromEmail"]').val(),feedback:t.options.$feedback.find('textarea[name="feedback"]').val()},function(e){return t.options.$feedback.find('textarea[name="feedback"]').val("")})}),e=$(""+this.options.fileUploader+" ul"),$(""+this.options.dropZone+" a").click(function(){return $(this).parent().find("input").click()}),this.options.$fileUploader.fileupload({dropZone:this.options.$dropZone,add:function(o,i){var n,a;a=$('<li class="working">\n  <input type="text" value="0" data-width="40" data-height="40" data-fgColor="#ff004a" data-readOnly="1" data-bgColor="#3e4043" />\n  <p></p>\n  <span></span>\n</li>'),a.find("p").text(i.files[0].name).append("<i>"+t.formatFileSize(i.files[0].size)+"</i>"),i.context=a.appendTo(e),a.find("input").knob(),a.find("span").click(function(){a.hasClass("working")&&n.abort(),a.fadeOut(function(){a.remove()})}),n=i.submit()},progress:function(e,t){var o;o=parseInt(t.loaded/t.total*100,10),t.context.find("input").val(o).change(),100===o&&t.context.removeClass("working")},fail:function(e,t){t.context.addClass("error"),swal({title:"Error!",text:"There was an error uploading file.",confirmButtonColor:"#ff004a",type:"error"})}}),$(document).on("drop dragover",function(e){return e.preventDefault()})},Backdoor.prototype.formatFileSize=function(e){return"number"!=typeof e?"":e>=1e9?(e/1e9).toFixed(2)+" GB":e>=1e6?(e/1e6).toFixed(2)+" MB":(e/1e3).toFixed(2)+" KB"},Backdoor.prototype.readCookie=function(e){var t,o,i,n;for(n=document.cookie,o=n.split(";"),i=0;i<o.length;){if(t=o[i].split("="),e.trim()===t[0].trim())return decodeURIComponent(t[1]);i++}},Backdoor.prototype.isOpened=function(e){var t,o;return o=this,t=!1,this.options.$views.find(".view").each(function(){var i,n;return i=o.options.webDevDir+$(this).find('input[name="fileLoc"]').val(),i===e?(n=$(this).data("view-id"),$(this).siblings().removeClass("active"),$(this).addClass("active"),o.options.$tabViews.find("li.active").removeClass("active"),o.options.$tabViews.find('li[data-id="'+n+'"]').addClass("active"),t=!0):void 0}),t},Backdoor.prototype.adjustChatViewHeight=function(){var e,t,o,i;return e=$(".header").outerHeight(),o=$(".chat-users").outerHeight(),i=$(window).height(),t=i-(e+o),$(".chat-list-to-convo").css("height",t)},Backdoor.prototype.scrollChatView=function(){return $(".chat-entries-scrollview").scrollTop($(".chat-entries-scrollview").prop("scrollHeight")),$(".chat-entries-scrollview").perfectScrollbar("update")},Backdoor.prototype.checkWhosOnline=function(){var e,t,o,i;return o=this,i={},t=[],e=[],this.serviceCall(this.global.apiUrls.chat.online,{},function(e){var t,o,n,a,s;for(o=0,n=e.users.length,t="",a=[];n>o;)s=e.users[o],i[s.id]=s,a.push(o++);return a}),this.serviceCall(this.global.apiUrls.chat.data,{},function(n){var a,s,r,l,c,d;for(c=n.users,s=0,r=c.length;r>s;s++)a=c[s],a.uid!==o.readCookie("backdoorUserId")&&(void 0!==i[a.uid]?(d='<div data-status="on" data-id="'+a.uid+'" data-user="'+a.email+'" class="chat-user">\n  <span class="on"></span> <span>'+a.email+"</span> <span>("+i[a.uid].timestamp+")</span>\n</div>",t.push(d)):(d='<div data-status="off" data-id="'+a.uid+'" data-user="'+a.email+'" class="chat-user">\n  <span class="off"></span> <span>'+a.email+"</span>\n</div>",e.push(d)));return l=t.concat(e),o.options.$chat.find(".chat-users-scrollview").html(l.join(""))}),void 0!==this.global.timers.checkWhosOnline&&clearTimeout(this.global.timers.checkWhosOnline),this.checkBackInLoop("checkWhosOnline",this.options.chatOnlineRefresh)},Backdoor.prototype.createConversation=function(e){var t;return t=this,this.serviceCall(this.global.apiUrls.chat.create,{uid:this.readCookie("backdoorUserId"),wuid:e},function(e){return t.global.chat.file=e.file,t.openConversation(e.file)})},Backdoor.prototype.openConversation=function(e){var t;return t=this,void 0===e?e=this.global.chat.file:this.global.chat.file=e,void 0!==this.global.timers.getChatLog&&clearTimeout(this.global.timers.getChatLog),this.serviceCall(this.global.apiUrls.chat.open,{file:e},function(e){var o,i,n,a,s;for(i=e.chat,n=0,a=i.length,o="";a>n;)s=i[n].id===t.readCookie("backdoorUserId")?"me":"user",o+='<div class="chat-convo-entry">\n  <span class="'+s+'">'+i[n].user+":</span> "+i[n].text+' <span class="time">'+i[n].time+"</span>\n</div>",n++;return t.options.$chat.find(".chat-convo .chat-content").html(o),t.scrollChatView(),t.options.$body.addClass("open-conversation")}),void 0!==this.global.timers.openConversation&&clearTimeout(this.global.timers.openConversation),this.checkBackInLoop("openConversation",this.options.chatRefresh)},Backdoor.prototype.updateConversation=function(){var e,t,o,i,n;return t=this,e=this.global.chat.file,i=t.readCookie("backdoorUserId"),n=t.readCookie("backdoorUserEmail"),o=encodeURIComponent($(""+this.options.chat+" textarea").val()),this.serviceCall(this.global.apiUrls.chat.update,{file:e,uid:i,user:n,text:o},function(e){return $(""+t.options.chat+" textarea").val(""),t.openConversation()})},Backdoor.prototype.getUserData=function(e){return this.serviceCall(this.global.apiUrls.chat.data,{uids:e},function(e){return e.user})},Backdoor.prototype.getChatLog=function(e,t){var o;return null==t&&(t=!1),o=this,this.global.chat.logViewUID=e,void 0!==this.global.timers.openConversation&&clearTimeout(this.global.timers.openConversation),this.serviceCall(this.global.apiUrls.chat.log,{},function(i){var n,a,s,r,l,c,d,p,u,h,f,v,m,b,w,g;if(c=i[o.readCookie("backdoorUserId")],!$.isEmptyObject(c)){l=0,s="";for(n in c){for(a=c[n],r=c[n],u=0,v=r.members.length,h=[],f=[],p=!1;v>u;)r.members[u]===e&&(l++,p=!0),u++;if(p||"all"===e){for(u=0,b=o.getUserData(r.members.join(",")),g=JSON.parse(b.responseText);v>u;)d=h.push(g.users[u].email),f.push(g.users[u].uid),u++;o.global.chat.file=r.file,w=h.join(", "),m=f.join(","),s+='<div data-chat-file="'+r.file+'" data-user-ids="'+m+'" class="chat-list">\n  '+w+"\n</div>"}}}return 0!==l&&!$.isEmptyObject(c)||"all"===e?1!==l||"all"===e||t?o.options.$body.removeClass("open-conversation"):o.openConversation():o.createConversation(e),o.options.$chat.find(".chat-lists .chat-content").html(s)}),void 0!==this.global.timers.getChatLog&&clearTimeout(this.global.timers.getChatLog),this.checkBackInLoop("getChatLog",this.options.chatLogRefresh,this.global.chat.logViewUID)},Backdoor.prototype.buildScrollbar=function(){var e;return e=this,$("#fileBrowser,.file-uploader-list,.chat-users-scrollview,.chat-entries-scrollview").perfectScrollbar({minScrollbarLength:20,includePadding:!0})},Backdoor.prototype.createView=function(e,t,o){var i,n,a,s,r,l,c,d,p,u,h,f,v;if(f=this,a=new Date,d=a.getTime()+Math.floor(9999*Math.random()+1),p='<li class="tab active" data-id="'+d+'">\n  <button class="close"><i class="fa fa-times"></i></button>\n  '+o+"\n</li>","editor"===e){for(i=$("<textarea></textarea>"),i.addClass("view-textarea"),r=t.replace(/^.*\/\/[^\/]+/,""),v=this.options.webDevDir.replace(/^.*\/\/[^\/]+/,""),s=v.split("/"),l=0,c=s.length;c>l;l++)n=s[l],""!==n&&(h="/"+n,r=r.replace(h,""));return $.when("new"!==t?this.serviceCall(this.global.apiUrls.file.loader,{fileLoc:r},function(e){return f.format=e.format,f.contentHolder=e.content}):(f.contentHolder="",f.format="plain")).then(function(){var e,t;return i.text(f.contentHolder),t=i.get(0).outerHTML,e='<div class="view active" data-view-id="'+d+'" data-editor-mode="'+f.format+'">\n  <input type="hidden" name="fileLoc" value="'+r+'">\n  '+t+'\n  <div class="view-character-count">0</div>\n  <select class="view-mode">\n    <option value="plain">plain</option>\n    <option value="coffeescript">coffeescript</option>\n    <option value="css">css</option>\n    <option value="htmlmixed">html</option>\n    <option value="jade">jade</option>\n    <option value="javascript">javascript</option>\n    <option value="markdown">markdown</option>\n    <option value="perl">perl</option>\n    <option value="php">php</option>\n    <option value="python">python</option>\n    <option value="ruby">ruby</option>\n    <option value="sass">sass</option>\n    <option value="shell">shell</option>\n    <option value="sql">sql</option>\n    <option value="vb">vb</option>\n    <option value="vbscript">vbscript</option>\n    <option value="xml">xml</option>\n    <option value="yaml">yaml</option>\n  </select>\n</div>',f.addView(p,e)})}return"file"===e?(u='<div class="view active" data-view-id="'+d+'">\n  <iframe src="'+t+'"></iframe>\n</div>',this.addView(p,u)):"player"===e?(u='<div class="view active" data-view-id="'+d+'">\n  \n</div>',this.addView(p,u)):void 0},Backdoor.prototype.addView=function(e,t){return $("#tabViews").find(".active").removeClass("active"),$("#tabViews").append(e),$("#views").find(".active").removeClass("active"),$("#views").append(t),this.format=null,this.contentHolder=null},Backdoor.prototype.getDirectory=function(e,t){var o;return o=this,$.ajax({headers:{"BD-API-SESSION":o.options.token},url:t,dataType:"json",error:function(e,t,o){return console.log(o)},success:function(t,i,n){return null===t.messages?o.buildDirectory(e,t):void 0}})},Backdoor.prototype.buildDirectory=function(e,t){var o,i,n,a,s,r,l,c,d,p,u,h,f,v,m,b,w;for(l=new Date,w="ul_"+l.getTime()+Math.floor(9999*Math.random()+1),n="",a=[],v=t.breadcrumbs,d=0,u=v.length;u>d;d++)o=v[d],n+='<li>\n  <button data-url="'+o.link+'">'+o.text+"</button>\n</li>","Home"!==o.text&&a.push(o.text);for(s="<ul>\n  "+n+"\n</ul>",c=a.join("/"),$("#currentDir").val(""+c+"/"),this.options.$breadcrumbId.html(s),f="",m=t.files,p=0,h=m.length;h>p;p++)i=m[p],r="",i.isfolder&&(r='class="folder"'),i.size="-"===i.size||"0.00B"===i.size?"":"<span>("+i.size+")</span>",f+="<li "+r+' data-modified="'+i.lastmodified+'">\n  <i class="fa '+i.icon+'"></i>\n  <button class="browser-button" data-url="'+i.url+'" data-open="'+i.handler+'">'+i.filename+" "+i.size+"</button>\n</li>";return b='<ul id="'+w+'">\n  '+f+"\n</ul>",e.find("ul").remove(),e.append(b),this.scrollBuilt?void 0:(this.buildScrollbar(),this.scrollBuilt=!0)},Backdoor.prototype.ucwords=function(e){return e.toLowerCase(),e.replace(/(\b)([a-zA-Z])/g,function(e){return e.toUpperCase()})},Backdoor.prototype.resetContext=function(){return this.options.$rightClickMenu.html("").css({top:"-9999px",left:"-9999px"})},Backdoor.prototype.processRequest=function(){var _self;return _self=this,$.ajax({headers:{"BD-API-SESSION":_self.options.token},url:_self.global.apiUrls.file.handler,method:"POST",async:!1,data:{callType:_self.contextCall,fileLoc:_self.contextFile,miscData:_self.contextData},dataType:"json",error:function(xhr,status,error){var err;return err=eval("("+xhr.responseText+")"),console.log(err.Message),_self.options.$body.removeClass("open-context"),_self.resetContext()},success:function(e,t,o){var i;return i=_self.currentDirUrl,("deleteFile"===_self.contextCall||"copyFile"===_self.contextCall||"newFolder"===_self.contextCall)&&(i=_self.options.webDevDir+"/backdoor_browser.php"),_self.getDirectory(_self.options.$browserId,i),_self.options.$body.removeClass("open-context"),_self.resetContext()}})},Backdoor.prototype.saveDoc=function(){var e,t,o,i,n,a,s;if(a=this,e=a.options.$views.find(".view.active"),a.options.$fileMenu.find(".open-file-menu").removeClass("open-file-menu"),e.length){if(o=e.data("view-id"),document[o].save(),a.contextData=a.options.$views.find(".view.active").find("textarea.view-textarea").val(),"new"===this.contextFile||"saveasFile"===this.contextCall)return s=this.currentDirUrl,i=new RegExp("backdoor_browser.php[?&]dir=([^&#]*)").exec(s),s=null===i?"new"!==this.contextFile?this.contextFile:"/untitled":"/"+i[1]+"/untitled",swal({title:"Provide File Name",text:"Please provide filename and path:",type:"input",confirmButtonColor:"#ff004a",showCancelButton:!0,closeOnConfirm:!1,animation:"pop",inputValue:s},function(e){var t,i,n;return e===!1||""===e?(swal.showInputError("Filename/path can not be blank!"),!1):(a.contextFile=e,n=a.processRequest(),n.responseJSON.success?a.options.saveAlerts?swal({title:"Done!",text:"File has been saved!",confirmButtonColor:"#ff004a",type:"success"},function(){var t,i;return i=e.replace(/^.*[\\\/]/,""),a.options.$tabViews.find('li[data-id="'+o+'"]').html('<button class="close"><i class="fa fa-times"></i></button>'+i),a.options.$views.find('div[data-view-id="'+o+'"]').find('input[name="fileLoc"]').val(e),t=a.options.$tabViews.find(".active").find(".close"),t.parent().is("span")?t.unwrap():void 0}):(i=e.replace(/^.*[\\\/]/,""),a.options.$tabViews.find('li[data-id="'+o+'"]').html('<button class="close"><i class="fa fa-times"></i></button>'+i),a.options.$views.find('div[data-view-id="'+o+'"]').find('input[name="fileLoc"]').val(e),t=a.options.$tabViews.find(".active").find(".close"),t.parent().is("span")?t.unwrap():void 0):swal({title:"Error!",text:"There was an error saving this file.",confirmButtonColor:"#ff004a",type:"error"}))});if(n=a.processRequest(),!n.responseJSON.success)return swal({title:"Error!",text:"There was an error saving this file.",confirmButtonColor:"#ff004a",type:"error"});if(a.options.saveAlerts)return swal({title:"Done!",text:"File has been saved!",confirmButtonColor:"#ff004a",type:"success"},function(){var e;return e=a.options.$tabViews.find(".active").find(".close"),e.parent().is("span")?e.unwrap():void 0});if(t=a.options.$tabViews.find(".active").find(".close"),t.parent().is("span"))return t.unwrap()}},Backdoor.prototype.initContextCalls=function(){var e;return e=this,$(document).on("click",""+this.options.fileMenu+" button[data-context-call]",function(){return e.contextCall=$(this).data("context-call"),e.contextFile=e.options.$views.find(".view.active").find('input[name="fileLoc"]').val(),"saveFile"===e.contextCall||"saveasFile"===e.contextCall?e.saveDoc():void 0}),$(document).on("click",""+this.options.rightClickMenu+" button",function(){var t,o;return e.contextCall=$(this).data("context-call"),e.contextFile=$(this).data("file"),t=new RegExp("backdoor_browser.php[?&]dir=([^&#]*)").exec(e.contextFile),o=null===t?"file":"folder","renameFile"===e.contextCall?(swal({title:"Rename "+e.ucwords(o),text:"What would you like to rename this "+o+"?",type:"input",confirmButtonColor:"#ff004a",showCancelButton:!0,closeOnConfirm:!1,animation:"pop",inputPlaceholder:"Rename Here"},function(t){var i;return t===!1||""===t?(swal.showInputError("Item name can not be blank!"),!1):(e.contextData=t,i=e.processRequest(),i.responseJSON.success?e.options.saveAlerts?swal({title:"Done!",text:e.ucwords(o)+" has been renamed!",confirmButtonColor:"#ff004a",type:"success"}):void 0:swal({title:"Error!",text:"There was an error renaming "+o+".",confirmButtonColor:"#ff004a",type:"error"}))}),e.resetContext()):"deleteFile"===e.contextCall?(swal({title:"Delete "+e.ucwords(o),text:"Are you sure you want to delete this "+o+"?",confirmButtonColor:"#ff004a",showCancelButton:!0,animation:"pop"},function(t){var o;return t?o=e.processRequest():void 0}),e.resetContext()):"newFolder"===e.contextCall?(swal({title:"Create Folder",text:"What would you like to name this folder?",type:"input",confirmButtonColor:"#ff004a",showCancelButton:!0,closeOnConfirm:!1,animation:"pop",inputPlaceholder:"Folder Name"},function(t){var o;return t===!1||""===t?(swal.showInputError("Folder name can not be blank!"),!1):(e.contextData=t,o=e.processRequest(),o.responseJSON.success?e.options.saveAlerts?swal({title:"Done!",text:"Folder has been created!",confirmButtonColor:"#ff004a",type:"success"}):void 0:swal({title:"Error!",text:"There was an error creating folder.",confirmButtonColor:"#ff004a",type:"error"}))}),e.resetContext()):"previewBrowser"===e.contextCall?(window.open(e.contextFile),e.resetContext()):"newFile"===e.contextCall?(e.createView("editor","new","untitled"),e.resetContext()):"saveFile"===e.contextCall||"saveasFile"===e.contextCall?(e.saveDoc(),e.resetContext()):e.processRequest()})},Backdoor.prototype.populateMenu=function(e,t){var o,i,n;switch(this.options.$body.hasClass("open-context")||this.options.$body.addClass("open-context"),this.options.$rightClickMenu.css({top:this.mY+5,left:this.mX+5}),i=0,n=null,e){case"browserButtonFile":n=[{title:"Copy","function":"copyFile",data:t},{title:"Rename","function":"renameFile",data:t},{title:"Delete","function":"deleteFile",data:t}];break;case"browserButtonFolder":n=[{title:"New Folder","function":"newFolder",data:t},{title:"Copy","function":"copyFile",data:t},{title:"Rename","function":"renameFile",data:t},{title:"Delete","function":"deleteFile",data:t}];break;case"browserArea":n=[{title:"New Folder","function":"newFolder",data:t},{title:"New File","function":"newFile",data:t}];break;case"tab":n=[{title:"Save File","function":"saveFile",data:t},{title:"Preview in Browser","function":"previewBrowser",data:t}]}for(o="<ul>";i<n.length;)o+='<li><button data-context-call="'+n[i]["function"]+'" data-file="'+n[i].data+'">'+n[i].title+"</button></li>",i++;return o+="</ul>",this.options.$rightClickMenu.html(o)},Backdoor.prototype.handler=function(e){var t,o,i,n,a;return e.preventDefault(),n=this,"browser-button"===e.target.classList[0]?(t=e.target.dataset.url,o=new RegExp("[?&]dir=([^&#]*)").exec(t),null===o?this.populateMenu("browserButtonFile",t):this.populateMenu("browserButtonFolder",t)):"fileBrowser"===e.target.id?(t=this.options.webDevDir,this.populateMenu("browserArea",t)):"tab"===e.target.classList[0]||"tab"===e.target.parentElement.classList[0]?(a=e.target.dataset.id,void 0===a&&(a=e.target.parentElement.dataset.id),i=this.options.$views.find('.view[data-view-id="'+a+'"]').find('input[name="fileLoc"]').val(),t="new"!==i?this.options.webDevDir+i:i,this.populateMenu("tab",t)):(this.options.$body.removeClass("open-context"),n.resetContext())},Backdoor.prototype.listener=function(){var e;return e=this,document.addEventListener?document.addEventListener("contextmenu",function(t){return t.preventDefault(),e.handler(t)},!1):document.attachEvent("oncontextmenu",function(t){return t.preventDefault(),e.handler(t)})},Backdoor.prototype.tracker=function(){var e,t;return e=this,t=null,$(document).mousemove(function(o){return clearTimeout(t),t=setTimeout(function(){return e.mX=o.pageX,e.mY=o.pageY},100)})},Backdoor.prototype.updateMode=function(e,t){return console.log("Updated to: "+t),e.setOption("mode",t)},Backdoor}()});